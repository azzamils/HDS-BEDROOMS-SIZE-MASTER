<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HDS Master v30</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; background: #6b77ad; color: #fff; padding: 10px; margin: 0; }
        .card { max-width: 600px; margin: auto; background: #5a6594; border-radius: 12px; padding: 15px; border: 2px solid #e0b0d5; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        label { display: block; font-size: 0.7rem; color: #cbd5e1; margin-bottom: 4px; font-weight: bold; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #e0b0d5; background: #4a5481; color: white; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; }
        .mode-toggle { display: flex; gap: 5px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 10px; border: 1px solid #e0b0d5; background: #4a5481; color: white; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .active-mode { background: #e0b0d5; color: #4a5481; }
        
        /* PREVIEW */
        .system-preview { display: flex; justify-content: center; gap: 15px; margin: 20px 0; background: #222; padding: 20px; border-radius: 10px; border: 2px solid #e0b0d5; overflow-x: auto; }
        .door-column { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .door-container { width: 115px; height: 170px; border: 3px solid #e0b0d5; display: flex; flex-direction: column; background: #111; padding: 5px; box-sizing: border-box; border-radius: 4px; }
        .panel-select { width: 100%; font-size: 10px; padding: 4px; background: #334155; border: 1px solid #64748b; color: white; border-radius: 3px; cursor: pointer; flex: 1; margin: 2px 0; }
        .mid-bar-visual { height: 6px; background: #e0b0d5; width: 100%; margin: 2px 0; border-radius: 1px; }
        .add-panel-btn { background: #e0b0d5; color: #4a5481; border: none; border-radius: 4px; padding: 6px 10px; font-size: 10px; font-weight: bold; cursor: pointer; }

        .calc-btn { width: 100%; padding: 18px; background: #e0b0d5; border: none; border-radius: 8px; font-weight: bold; color: #4a5481; font-size: 1.2rem; cursor: pointer; }
        .print-btn { width: 100%; padding: 12px; background: #334155; color: #e0b0d5; border: 1px solid #e0b0d5; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; display: none; }
        
        .result-area { background: #334155; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #e0b0d5; color: #f1f5f9; display: none; }
        .group-block { margin-bottom: 20px; border-bottom: 1px solid #475569; padding-bottom: 15px; display: flex; gap: 20px; align-items: center; }
        .spec-content { flex: 1; }
        .spec-line { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #47556955; }
        .val { font-weight: bold; font-family: monospace; color: #fbbf24; font-size: 1.2rem; }
        .highlight { color: #e0b0d5; font-weight: bold; }
        
        /* PRINT DIAGRAMS */
        #printMasterLayout { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; border: 2px solid #000; padding: 20px; background: #fff; display: none; }
        .print-door { width: 80px; height: 120px; border: 2px solid #000; display: flex; flex-direction: column; background: #fff; position: relative; }
        .print-panel { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border-bottom: 1px solid #ddd; color: #000; }
        .print-mid-bar { height: 4px; background: #000; width: 100%; }
        .door-tag { position: absolute; bottom: -20px; width: 100%; text-align: center; font-weight: bold; font-size: 12px; color: #000; }

        .mini-map { width: 55px; height: 90px; border: 1px solid #fff; display: flex; flex-direction: column; flex-shrink: 0; background: #000; }
        .map-p { flex: 1; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; color: #fff; }

        @media print {
            body * { visibility: hidden !important; }
            #res, #res * { visibility: visible !important; color: black !important; }
            #res { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; background: white !important; padding: 0 !important; }
            #printMasterLayout { display: flex !important; visibility: visible !important; }
            #printMasterLayout * { visibility: visible !important; }
            .group-block { border-bottom: 2px solid #000 !important; padding: 10px !important; page-break-inside: avoid; }
            .val { color: black !important; font-size: 1.3rem !important; }
            .mini-map { border: 2px solid #000 !important; }
            .map-p { border-bottom: 1px solid #000 !important; color: black !important; }
        }
    </style>
</head>
<body>
<div class="card">
    <input type="text" id="jobName" placeholder="JOB REFERENCE">
    <div class="mode-toggle">
        <button id="btnSys" class="mode-btn active-mode" onclick="setMode('system')">SYSTEM (OP)</button>
        <button id="btnSingle" class="mode-btn" onclick="setMode('single')">SINGLE (FDS)</button>
    </div>
    <div style="display:flex; gap:10px;">
        <div style="flex:1;"><label id="lblW">WIDTH</label><input type="number" id="valW" step="any"></div>
        <div style="flex:1;"><label id="lblH">HEIGHT</label><input type="number" id="valH" step="any"></div>
    </div>
    <div style="display:flex; gap:10px;">
        <div style="flex:1;"><label>RANGE</label>
            <select id="range" onchange="updateColours()">
                <option value="harris">Harris (Lag)</option>
                <option value="col_lag">Colquhoun (Lag)</option>
                <option value="darroch">Darroch (A)</option>
                <option value="col_a">Colquhoun (A)</option>
            </select>
        </div>
        <div style="flex:1;"><label>COLOUR</label><select id="colour"></select></div>
    </div>
    <div id="qtyBox"><label>DOORS</label><select id="doorQty" onchange="initSystem()"><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
    <div class="system-preview" id="sysVisual"></div>
    <button class="calc-btn" onclick="calculate()">GENERATE CUT LIST</button>
    <button class="print-btn" id="printBtn" onclick="window.print()">üñ®Ô∏è PRINT LIST</button>
    
    <div id="res" class="result-area">
        <h2 id="resMeta" style="text-align:center; margin-top:0; border-bottom: 1px solid #e0b0d5; padding-bottom: 10px;"></h2>
        <div id="printMasterLayout"></div>
        <div id="doorGroupResults"></div>
    </div>
</div>

<script>
let currentMode = 'system';
let systemData = []; 
const matShort = ['S/M', 'G/M', 'B/M', 'W']; 
const matFull = ['Silver Mirror', 'Grey Mirror', 'Bronze Mirror', 'Wood'];
const colMap = { harris:["White","Silver","Champagne","Black"], col_lag:["White","Silver","Champagne","Black"], darroch:["N/A"], col_a:["N/A"] };

function setMode(m) {
    currentMode = m;
    document.getElementById('btnSys').className = m==='system' ? 'mode-btn active-mode' : 'mode-btn';
    document.getElementById('btnSingle').className = m==='single' ? 'mode-btn active-mode' : 'mode-btn';
    document.getElementById('lblW').innerText = m==='system' ? 'OP WIDTH' : 'FDS WIDTH';
    document.getElementById('lblH').innerText = m==='system' ? 'OP HEIGHT' : 'FDS HEIGHT';
    document.getElementById('qtyBox').style.display = m==='system' ? 'block' : 'none';
    initSystem();
}

function updateColours() {
    const r = document.getElementById('range').value;
    const s = document.getElementById('colour'); s.innerHTML = '';
    colMap[r].forEach(c => { let o = document.createElement('option'); o.value=c; o.text=c; s.appendChild(o); });
}

function initSystem() {
    const qty = currentMode === 'system' ? parseInt(document.getElementById('doorQty').value) : 1;
    systemData = []; for(let i=0; i<qty; i++) systemData.push([0]); 
    renderUI();
}

function renderUI() {
    const container = document.getElementById('sysVisual'); container.innerHTML = '';
    systemData.forEach((panels, dIdx) => {
        let col = document.createElement('div'); col.className = 'door-column';
        let door = document.createElement('div'); door.className = 'door-container';
        panels.forEach((pIdx, idx) => {
            let sel = document.createElement('select'); sel.className = 'panel-select';
            matShort.forEach((label, i) => { let o = document.createElement('option'); o.value=i; o.text=label; if(i===pIdx) o.selected=true; sel.appendChild(o); });
            sel.onchange = (e) => { systemData[dIdx][idx] = parseInt(e.target.value); };
            door.appendChild(sel);
            if(idx < panels.length - 1) { let bar = document.createElement('div'); bar.className = 'mid-bar-visual'; door.appendChild(bar); }
        });
        col.innerHTML = `<div class="door-label" style="font-size:10px; margin-bottom:2px;">DOOR ${String.fromCharCode(65 + dIdx)}</div>`;
        col.appendChild(door);
        let btn = document.createElement('button'); btn.className = 'add-panel-btn'; btn.innerText = 'Split';
        btn.onclick = () => { let n = panels.length >= 3 ? 1 : panels.length+1; systemData[dIdx] = new Array(n).fill(0); renderUI(); };
        col.appendChild(btn); container.appendChild(col);
    });
}

function calculate() {
    const r = document.getElementById('range').value;
    const rules = { harris:{o:30,m:58,g:23,w:30}, col_lag:{o:35,m:50,g:20,w:20}, darroch:{o:27,m:52,g:13,w:13}, col_a:{o:35,m:46,g:14,w:14} };
    const active = rules[r];
    const w = parseFloat(document.getElementById('valW').value) || 0;
    const h = parseFloat(document.getElementById('valH').value) || 0;
    if(!w || !h) return;

    let fW = Math.round(currentMode === 'system' ? (w + (active.o * (systemData.length - 1))) / systemData.length : w);
    let fH = Math.round(currentMode === 'system' ? h - 45 : h);
    
    document.getElementById('resMeta').innerText = (document.getElementById('jobName').value || 'CUT LIST').toUpperCase() + " | " + document.getElementById('colour').value + " | " + document.getElementById('range').options[document.getElementById('range').selectedIndex].text;
    
    // BUILD PRINT MASTER LAYOUT
    let masterHtml = '';
    systemData.forEach((pArray, i) => {
        masterHtml += `<div class="print-door">`;
        pArray.forEach((pIdx, idx) => {
            masterHtml += `<div class="print-panel">${matShort[pIdx]}</div>`;
            if(idx < pArray.length - 1) masterHtml += `<div class="print-mid-bar"></div>`;
        });
        masterHtml += `<div class="door-tag">Door ${String.fromCharCode(65+i)}</div></div>`;
    });
    document.getElementById('printMasterLayout').innerHTML = masterHtml;

    let groups = [];
    systemData.forEach((p, i) => {
        let k = JSON.stringify(p); let m = groups.find(g => g.key === k);
        if(m) m.names.push(String.fromCharCode(65+i)); else groups.push({key:k, panels:p, names:[String.fromCharCode(65+i)]});
    });

    let resHtml = '';
    groups.forEach(g => {
        let pCount = g.panels.length;
        let midD = 0;
        for(let i=0; i<pCount-1; i++) {
            if(g.panels[i]===3 || g.panels[i+1]===3) midD += (g.panels[i]!==g.panels[i+1] ? 6 : 11);
            else midD += 1;
        }
        let hFix = (g.panels[0]===3?20:15) + (g.panels[pCount-1]===3?41:35) + midD;
        let pH = Math.round(((fH - hFix) / pCount) - (1.0 / pCount));

        let map = `<div class="mini-map">`;
        g.panels.forEach(p => map += `<div class="map-p">${matShort[p]}</div>`);
        map += `</div>`;

        resHtml += `<div class="group-block">${map}<div class="spec-content">
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #e0b0d555; margin-bottom:5px;">
                <span class="highlight">DOORS: ${g.names.join(', ')}</span><span class="highlight">FDS: ${fW}x${fH}</span>
            </div>
            <div class="spec-line"><span>Metal Rails:</span> <span class="val">${Math.round(fW - active.m)} x ${fH}</span></div>`;
        matFull.forEach((label, idx) => {
            let count = g.panels.filter(p => p === idx).length * g.names.length;
            if(count > 0) resHtml += `<div class="spec-line"><span>${label}:</span> <span class="val">${count} @ ${Math.round(fW - (idx===3?active.w:active.g))} x ${pH}</span></div>`;
        });
        resHtml += `</div></div>`;
    });
    document.getElementById('doorGroupResults').innerHTML = resHtml;
    document.getElementById('res').style.display = 'block';
    document.getElementById('printBtn').style.display = 'block';
    window.scrollTo({ top: document.getElementById('res').offsetTop, behavior: 'smooth' });
}
updateColours();
initSystem();
</script>
</body>
</html>
